import feedparser
import requests
import re
import time
from googletrans import Translator

# ================= é…ç½®åŒºåŸŸ =================
RSS_åœ°å€ = "https://rss.app/feeds/11Y5Vv2cCKUI9mB0.xml"
# âš ï¸ è¯·å¡«å…¥æ–°çš„ Keyï¼Œä¸è¦ä½¿ç”¨æ³„éœ²çš„æ—§ Key
å¾®ä¿¡æœºå™¨äººé“¾æ¥ = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=ä½ çš„æ–°KEY" 
è½®è¯¢é—´éš”ç§’ = 60
# ===========================================

translator = Translator()
å·²å‘é€é“¾æ¥ = set()
æ˜¯é¦–æ¬¡è¿è¡Œ = True  # æ ‡è®°æ˜¯å¦æ˜¯è„šæœ¬åˆšå¯åŠ¨

def è‡ªåŠ¨ç¿»è¯‘(æ–‡æœ¬):
    if not æ–‡æœ¬: return ""
    try:
        # å¢åŠ  service_urls å¯ä»¥æé«˜ç¨³å®šæ€§ï¼Œæˆ–è€…ç›´æ¥é‡è¯•
        res = translator.translate(æ–‡æœ¬, src='en', dest='zh-cn')
        return res.text
    except Exception as e:
        print(f"âš ï¸ ç¿»è¯‘æœåŠ¡æš‚æ—¶ä¸å¯ç”¨: {e}")
        return "ï¼ˆç¿»è¯‘å¤±è´¥ï¼Œè¯·çœ‹åŸæ–‡ï¼‰"

def å‘é€åˆ°å¾®ä¿¡(ä¸­æ–‡, è‹±æ–‡, é“¾æ¥, å›¾ç‰‡ä»£ç ):
    # æ„å»º Markdown æ¶ˆæ¯
    å†…å®¹ = f"""### ğŸš€ é©¬æ–¯å…‹æœ€æ–°æ¨æ–‡
    
**ã€ä¸­æ–‡ç¿»è¯‘ã€‘**
{ä¸­æ–‡}

**ã€è‹±æ–‡åŸè¯ã€‘**
{è‹±æ–‡}
{å›¾ç‰‡ä»£ç }

[ğŸ‘‰ ç‚¹å‡»è·³è½¬æ¨ç‰¹åŸæ–‡]({é“¾æ¥})
"""
    æ•°æ®åŒ… = {"msgtype": "markdown", "markdown": {"content": å†…å®¹}}
    try:
        å“åº” = requests.post(å¾®ä¿¡æœºå™¨äººé“¾æ¥, json=æ•°æ®åŒ…, timeout=10)
        if å“åº”.status_code == 200:
            print(f"âœ… [å‘é€æˆåŠŸ] {è‹±æ–‡[:20]}...")
        else:
            print(f"âŒ [å‘é€å¤±è´¥] çŠ¶æ€ç : {å“åº”.status_code}, å“åº”: {å“åº”.text}")
    except Exception as e:
        print(f"âŒ [ç½‘ç»œå¼‚å¸¸] å‘é€å¾®ä¿¡å¤±è´¥: {e}")

def æ£€æŸ¥æ¨æ–‡():
    global æ˜¯é¦–æ¬¡è¿è¡Œ
    print(f"ğŸ” [{time.strftime('%H:%M:%S')}] æ­£åœ¨æ£€æŸ¥æ›´æ–°...")
    
    try:
        æ•°æ®æº = feedparser.parse(RSS_åœ°å€)
    except Exception as e:
        print(f"âš ï¸ RSS è¿æ¥å¤±è´¥: {e}")
        return

    if not æ•°æ®æº.entries:
        print("âš ï¸ æœªè·å–åˆ° RSS å†…å®¹")
        return

    # â— é‡è¦ï¼šä½¿ç”¨ reversed() å€’åºï¼Œä¿è¯å¦‚æœåœ¨é—´éš”æœŸå‘äº†å¤šæ¡ï¼ŒæŒ‰æ—¶é—´é¡ºåºå‘é€
    æ–°æ¨æ–‡åˆ—è¡¨ = []
    
    for å¸–å­ in reversed(æ•°æ®æº.entries):
        link = å¸–å­.link
        if link in å·²å‘é€é“¾æ¥:
            continue
            
        # è®°å½•åˆ°å¾…å‘é€åˆ—è¡¨
        æ–°æ¨æ–‡åˆ—è¡¨.append(å¸–å­)
        # æ— è®ºæ˜¯å¦é¦–æ¬¡è¿è¡Œï¼Œéƒ½è¦åŠ å…¥é›†åˆï¼Œé˜²æ­¢é‡å¤
        å·²å‘é€é“¾æ¥.add(link)

    # å¦‚æœæ˜¯è„šæœ¬åˆšå¯åŠ¨ï¼Œåªè®°å½•é“¾æ¥ï¼Œä¸å‘é€ï¼ˆé˜²æ­¢åˆ·å±ï¼‰
    if æ˜¯é¦–æ¬¡è¿è¡Œ:
        print(f"ğŸ è„šæœ¬åˆå§‹åŒ–å®Œæˆï¼Œå·²æ ‡è®° {len(æ–°æ¨æ–‡åˆ—è¡¨)} æ¡å†å²æ¨æ–‡ä¸ºå·²è¯»ã€‚ç­‰å¾…æ–°æ¨æ–‡...")
        æ˜¯é¦–æ¬¡è¿è¡Œ = False
        return

    # å¤„ç†æ–°æ¨æ–‡
    for å¸–å­ in æ–°æ¨æ–‡åˆ—è¡¨:
        åŸæ–‡å†…å®¹ = å¸–å­.title
        è¯¦ç»†æè¿° = å¸–å­.description
        æ¨æ–‡é“¾æ¥ = å¸–å­.link

        # æå–å›¾ç‰‡ (æ›´å®‰å…¨çš„å†™æ³•)
        å›¾ç‰‡ä»£ç  = ""
        å›¾ç‰‡åŒ¹é… = re.search(r'src="([^"]+\.(?:jpg|png|gif|jpeg)[^"]*)"', è¯¦ç»†æè¿°)
        if å›¾ç‰‡åŒ¹é…:
            å›¾ç‰‡ä»£ç  = f"\n![å›¾ç‰‡]({å›¾ç‰‡åŒ¹é….group(1)})"

        print(f"âš¡ å‘ç°æ–°æ¨æ–‡ï¼Œæ­£åœ¨å¤„ç†: {åŸæ–‡å†…å®¹[:30]}...")
        
        # ç¿»è¯‘
        ä¸­æ–‡å†…å®¹ = è‡ªåŠ¨ç¿»è¯‘(åŸæ–‡å†…å®¹)
        
        # å‘é€
        å‘é€åˆ°å¾®ä¿¡(ä¸­æ–‡å†…å®¹, åŸæ–‡å†…å®¹, æ¨æ–‡é“¾æ¥, å›¾ç‰‡ä»£ç )
        
        # é¿å…ç¬é—´å‘é€è¿‡å¤šè§¦å‘é¢‘ç‡é™åˆ¶ï¼Œç¨å¾®åœé¡¿
        time.sleep(2) 

def main():
    print("ğŸš€ é©¬æ–¯å…‹æ¨æ–‡ç›‘æ§å·²å¯åŠ¨ (æŒ‰ Ctrl+C åœæ­¢)...")
    while True:
        try:
            æ£€æŸ¥æ¨æ–‡()
        except KeyboardInterrupt:
            print("\nğŸ›‘ ç”¨æˆ·æ‰‹åŠ¨åœæ­¢è„šæœ¬")
            break
        except Exception as e:
            print(f"âš ï¸ ä¸»å¾ªç¯å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}")
        
        time.sleep(è½®è¯¢é—´éš”ç§’)

if __name__ == "__main__":
    main()

